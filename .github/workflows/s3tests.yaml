name: S3 Tests

on:
  pull_request:
    paths:
      - "**.go"
      - "integration/s3-test/**"
      - ".github/workflows/s3tests.yaml"
  push:
    branches:
      - main
    paths:
      - "**.go"
      - "integration/s3-test/**"
      - ".github/workflows/s3tests.yaml"
  workflow_dispatch:

jobs:
  s3-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      pull-requests: write
    outputs:
      has_results: ${{ steps.summary.outputs.has_results }}
      passed: ${{ steps.summary.outputs.passed }}
      failed: ${{ steps.summary.outputs.failed }}
      skipped: ${{ steps.summary.outputs.skipped }}
      errors: ${{ steps.summary.outputs.errors }}

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: recursive

      - uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.local/share/aquaproj-aqua
          key: v2-aqua-installer-${{runner.os}}-${{runner.arch}}-${{hashFiles('aqua.yaml')}}
          restore-keys: |
            v2-aqua-installer-${{runner.os}}-${{runner.arch}}-

      - uses: aquaproj/aqua-installer@11dd79b4e498d471a9385aa9fb7f62bb5f52a73c # v4.0.4
        with:
          aqua_version: v2.55.2

      - name: Run s3-test
        run: task s3-test || true

      - name: Generate summary
        id: summary
        working-directory: integration/s3-test
        run: |
          if [ ! -f s3-test.log ]; then
            echo "s3-test.log not found"
            echo "has_results=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          result_line=$(grep -oE '[0-9]+ (failed|passed|skipped|deselected|warnings?|errors?)(, [0-9]+ (failed|passed|skipped|deselected|warnings?|errors?))*' s3-test.log | tail -1)
          if [ -n "$result_line" ]; then
            failed=$(echo "$result_line" | grep -oE '[0-9]+ failed' | grep -oE '[0-9]+' || echo 0)
            passed=$(echo "$result_line" | grep -oE '[0-9]+ passed' | grep -oE '[0-9]+' || echo 0)
            skipped=$(echo "$result_line" | grep -oE '[0-9]+ skipped' | grep -oE '[0-9]+' || echo 0)
            errors=$(echo "$result_line" | grep -oE '[0-9]+ errors?' | grep -oE '[0-9]+' || echo 0)
            total=$((passed + failed + errors))
            if [ "$total" -gt 0 ]; then
              pass_rate=$(echo "scale=2; $passed * 100 / $total" | bc)
            else
              pass_rate="0"
            fi

            echo "passed=$passed" >> $GITHUB_OUTPUT
            echo "failed=$failed" >> $GITHUB_OUTPUT
            echo "skipped=$skipped" >> $GITHUB_OUTPUT
            echo "errors=$errors" >> $GITHUB_OUTPUT
            echo "pass_rate=$pass_rate" >> $GITHUB_OUTPUT
            echo "has_results=true" >> $GITHUB_OUTPUT
          else
            echo "has_results=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.summary.outputs.has_results == 'true'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const passed = '${{ steps.summary.outputs.passed }}';
            const failed = '${{ steps.summary.outputs.failed }}';
            const skipped = '${{ steps.summary.outputs.skipped }}';
            const errors = '${{ steps.summary.outputs.errors }}';
            const passRate = '${{ steps.summary.outputs.pass_rate }}';

            const body = `## S3 Test Summary

            | Metric | Count |
            |--------|-------|
            | Passed | ${passed} |
            | Failed | ${failed} |
            | Skipped | ${skipped} |
            | Errors | ${errors} |
            | **Pass Rate** | **${passRate}%** |

            <details>
            <summary>Run details</summary>

            - Workflow: \`${{ github.workflow }}\`
            - Run ID: \`${{ github.run_id }}\`
            - Commit: \`${{ github.sha }}\`
            </details>`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('## S3 Test Summary')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  publish-badge:
    needs: s3-tests
    if: needs.s3-tests.outputs.has_results == 'true' && github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Build badge payload
        run: |
          passed='${{ needs.s3-tests.outputs.passed }}'
          failed='${{ needs.s3-tests.outputs.failed }}'
          skipped='${{ needs.s3-tests.outputs.skipped }}'
          errors='${{ needs.s3-tests.outputs.errors }}'

          if [ "$failed" -eq 0 ] && [ "$errors" -eq 0 ]; then
            color="brightgreen"
          elif [ "$passed" -gt 0 ]; then
            color="yellow"
          else
            color="red"
          fi

          mkdir -p .github/badges
          cat > .github/badges/s3-tests.json <<EOF
          {
            "schemaVersion": 1,
            "label": "s3-tests",
            "message": "success ${passed}, fail ${failed}, skip ${skipped}, error ${errors}",
            "color": "${color}"
          }
          EOF

      - name: Update badge data
        run: |
          if git diff --quiet -- .github/badges/s3-tests.json; then
            echo "No badge changes"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .github/badges/s3-tests.json
          git commit -m "chore: update s3-test badge data"
          git fetch origin "${GITHUB_REF_NAME}"
          if ! git rebase "origin/${GITHUB_REF_NAME}"; then
            echo "::warning::Failed to rebase badge update onto latest ${GITHUB_REF_NAME}; skipping push."
            git rebase --abort || true
            exit 0
          fi
          if ! git push origin HEAD:${GITHUB_REF_NAME}; then
            echo "::warning::Failed to push badge update (likely concurrent push); skipping."
            exit 0
          fi
